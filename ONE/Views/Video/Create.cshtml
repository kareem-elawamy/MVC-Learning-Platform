@model ONE.Models.Video

@{
    ViewData["Title"] = "Add New Video";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    .form-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .preview-box {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        color: #adb5bd;
        flex-direction: column;
        transition: all 0.3s;
    }

    /* Loading Overlay for inputs */
    .input-loading {
        background-color: #f0f0f0;
        opacity: 0.7;
        pointer-events: none;
    }
</style>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark m-0">Add New Video</h3>
        <a asp-action="Index" class="btn btn-outline-secondary px-4">
            <i class="fas fa-arrow-left me-2"></i> Back
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="form-card p-4">
                <form asp-action="Create" method="post" id="createForm">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">YouTube URL</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white text-danger"><i class="fab fa-youtube"></i></span>
                            <input type="text" id="youtubeLink" class="form-control"
                                placeholder="Paste link (e.g., https://youtube.com/watch?v=...)"
                                oninput="handleUrlInput()">
                            <button type="button" class="btn btn-primary" onclick="fetchVideoData()" id="fetchBtn">
                                <i class="fas fa-sync-alt"></i> Fetch Info
                            </button>
                        </div>
                        <small class="text-muted">Title & Thumbnail will be fetched automatically.</small>
                    </div>

                    <input asp-for="VideoId" type="hidden" id="VideoId" />
                    <input asp-for="ThumbnailUrl" type="hidden" id="ThumbnailUrl" />

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label asp-for="Title" class="form-label fw-bold">Video Title</label>
                            <input asp-for="Title" class="form-control" id="videoTitle"
                                placeholder="Auto-filled from YouTube" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="MaterialID" class="control-label">Material</label>
                            <select asp-for="MaterialID" class="form-control" asp-items="ViewBag.MaterialID"></select>
                        </div>

                        <div class="col-md-12 mb-4">
                            <label asp-for="Description" class="form-label fw-bold">
                                Description
                                <span class="badge bg-light text-secondary border ms-2" id="descStatus">Optional</span>
                            </label>
                            <textarea asp-for="Description" class="form-control" id="videoDescription" rows="5"
                                placeholder="Auto-filled if API Key is provided, otherwise type manually..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 py-2 fw-bold shadow-sm">
                        <i class="fas fa-check-circle me-2"></i> Create Video
                    </button>
                </form>
            </div>
        </div>

        <div class="col-lg-4 mt-4 mt-lg-0">
            <h5 class="fw-bold mb-3">Preview</h5>
            <div class="form-card p-3 sticky-top" style="top: 20px;">
                <div id="videoPreview" class="preview-box">
                    <i class="fas fa-photo-video fa-3x mb-2 opacity-50"></i>
                    <span class="small text-muted">Waiting for link...</span>
                </div>
                <div class="mt-3 text-center">
                    <span class="badge bg-secondary" id="statusBadge">No Data</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // ==========================================
        // ⚙️ إعدادات الـ API (المهمة)
        // ==========================================

        // لو معاك مفتاح من جوجل حطه هنا عشان يجيب الوصف
        // لو سبته فاضي، هيجيب العنوان بس
        const YOUTUBE_API_KEY = "";

        // ==========================================

        function handleUrlInput() {
            const url = document.getElementById("youtubeLink").value;
            const videoId = extractVideoID(url);

            if (videoId) {
                document.getElementById("VideoId").value = videoId;
                // تحديث الصورة والمعاينة فوراً
                updatePreview(videoId);
            }
        }

        async function fetchVideoData() {
            const url = document.getElementById("youtubeLink").value;
            const videoId = extractVideoID(url);
            const fetchBtn = document.getElementById("fetchBtn");
            const titleInput = document.getElementById("videoTitle");
            const descInput = document.getElementById("videoDescription");

            if (!videoId) {
                alert("Please enter a valid YouTube URL first!");
                return;
            }

            // UI Loading State
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            titleInput.classList.add("input-loading");
            descInput.classList.add("input-loading");

            try {
                if (YOUTUBE_API_KEY) {
                    // 1. الطريقة البروفيشنال (تجيب كل حاجة)
                    await fetchWithGoogleAPI(videoId);
                } else {
                    // 2. الطريقة السهلة (تجيب العنوان بس)
                    await fetchWithNoEmbed(url);
                }
            } catch (error) {
                console.error(error);
                alert("Could not fetch data. You may need to enter it manually.");
            } finally {
                // Remove Loading State
                fetchBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Fetch Info';
                titleInput.classList.remove("input-loading");
                descInput.classList.remove("input-loading");
            }
        }

        // دالة استخراج الـ ID
        function extractVideoID(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            return (match && match[2].length == 11) ? match[2] : null;
        }

        // دالة تحديث المعاينة
        function updatePreview(videoId) {
            const thumbUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`; // Medium quality is enough for preview
            // بنخزن الصورة عالية الجودة في الداتابيز
            document.getElementById("ThumbnailUrl").value = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;

            const previewDiv = document.getElementById("videoPreview");
            previewDiv.style.border = "none";
            previewDiv.innerHTML = `
                        <div class="ratio ratio-16x9 w-100 rounded overflow-hidden shadow-sm">
                            <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                        </div>`;

            document.getElementById("statusBadge").className = "badge bg-success";
            document.getElementById("statusBadge").innerText = "ID: " + videoId;
        }

        // الطريقة 1: باستخدام Google API (عنوان + وصف)
        async function fetchWithGoogleAPI(videoId) {
            const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;

            const response = await fetch(apiUrl);
            const data = await response.json();

            if (data.items && data.items.length > 0) {
                const snippet = data.items[0].snippet;
                document.getElementById("videoTitle").value = snippet.title;
                document.getElementById("videoDescription").value = snippet.description;
                document.getElementById("descStatus").innerText = "Fetched via API";
                document.getElementById("descStatus").className = "badge bg-success ms-2";
            }
        }

        // الطريقة 2: باستخدام NoEmbed (عنوان فقط - مجاني وبدون مفتاح)
        async function fetchWithNoEmbed(url) {
            // بنستخدم noembed.com عشان نتخطى مشكلة الـ CORS
            const response = await fetch(`https://noembed.com/embed?url=${url}`);
            const data = await response.json();

            if (data.title) {
                document.getElementById("videoTitle").value = data.title;
                document.getElementById("videoDescription").placeholder = "Description fetching requires an API Key. Please type manually.";

                // تنبيه للمستخدم
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                Toast.fire({
                    icon: 'info',
                    title: 'Title fetched! Description requires API Key.'
                });
            }
        }

        // Cascading Dropdown Logic (نفس القديم)
        document.getElementById("trackId").addEventListener("change", function () {
            var trackId = this.value;
            var materialSelect = document.getElementById("MaterialID");
            materialSelect.disabled = true;

            if (trackId) {
                fetch(`/Video/GetMaterialsByTrack?trackId=` + trackId)
                    .then(response => response.json())
                    .then(data => {
                        materialSelect.innerHTML = '<option value="">Select Subject</option>';
                        data.forEach(item => {
                            materialSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                        });
                        materialSelect.disabled = false;
                    });
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
}