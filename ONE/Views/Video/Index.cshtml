@model IEnumerable<ONE.Models.Video>

@{
    ViewData["Title"] = "Manage Videos";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f9fa;
    }

    /* كارت الفلتر */
    .filter-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .form-label {
        font-weight: 500;
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* الجدول الاحترافي */
    .card-table {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }

    .table thead th {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 600;
        font-size: 0.85rem;
        border-bottom: 2px solid #e9ecef;
        padding: 12px 15px;
    }

    .table tbody td {
        vertical-align: middle;
        padding: 12px 15px;
        color: #212529;
        border-bottom: 1px solid #f1f1f1;
        font-size: 0.95rem;
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    /* الصور */
    .video-thumbnail {
        width: 80px;
        height: 45px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .video-thumbnail:hover {
        opacity: 0.8;
    }

    /* الأزرار في الجدول */
    .btn-action {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .btn-action-view {
        color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }

    .btn-action-view:hover {
        background-color: #0d6efd;
        color: #fff;
    }

    .btn-action-delete {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
    }

    .btn-action-delete:hover {
        background-color: #dc3545;
        color: #fff;
    }

    /* تحسين النصوص الطويلة */
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        max-width: 300px;
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0 text-dark">Video Management</h3>
        <a asp-action="Create" class="btn btn-primary px-4">
            <i class="fas fa-plus me-2"></i> Add Video
        </a>
    </div>

    <div class="filter-card p-4 mb-4">
        <form method="get" asp-action="Index">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Track</label>
                    <select id="trackId" name="trackId" class="form-select" asp-items="ViewBag.Tracks">
                        <option value="">All Tracks</option>
                    </select>
                </div>

                <div class="col-md-4 position-relative">
                    <label class="form-label">Subject</label>
                    <select id="materialId" name="materialId" class="form-select" asp-items="ViewBag.Materials">
                        <option value="">All Subjects</option>
                    </select>
                    <div id="loadingSpinner"
                        class="spinner-border spinner-border-sm text-primary position-absolute end-0 bottom-0 mb-2 me-4 d-none">
                    </div>
                </div>

                <div class="col-md-4">
                    <button type="submit" class="btn btn-dark w-100">
                        <i class="fas fa-search me-2"></i> Filter Results
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div class="card-table">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="100">Thumbnail</th>
                        <th>Title & Description</th>
                        <th>Track</th>
                        <th>Subject</th>
                        <th width="120" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var video in Model)
                    {
                        <tr>
                            <td>
                                <div onclick="playVideo('@video.VideoId', '@video.Title')" data-bs-toggle="modal"
                                    data-bs-target="#previewModal">
                                    <img src="@video.ThumbnailUrl" class="video-thumbnail" alt="Thumb">
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-dark mb-1">@video.Title</div>
                                <div class="text-truncate-2">@video.Description</div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border">
                                    @video.Material?.Track?.Name
                                </span>
                            </td>
                            <td>
                                <span class="fw-medium text-secondary">
                                    @video.Material?.Name
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-action btn-action-view"
                                        onclick="playVideo('@video.VideoId', '@video.Title')" data-bs-toggle="modal"
                                        data-bs-target="#previewModal" title="View">
                                        <i class="fas fa-play fa-sm"></i>
                                    </button>

                                    <form asp-action="Delete" asp-route-id="@video.Id" method="post" class="d-inline"
                                        onsubmit="return confirmDelete(event)">
                                        <button type="submit" class="btn btn-action btn-action-delete" title="Delete">
                                            <i class="fas fa-trash fa-sm"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (!Model.Any())
            {
                <div class="text-center py-5 text-muted">
                    <p class="mb-0">No videos found matching your criteria.</p>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title fw-bold" id="modalTitle">Video Preview</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                    onclick="stopVideo()"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe id="youtubeFrame" src="" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 1. Delete Confirmation
        function confirmDelete(e) {
            e.preventDefault();
            var form = e.target;
            Swal.fire({
                title: 'Delete Video?',
                text: "This action cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#212529', // Dark color
                cancelButtonColor: '#dee2e6',
                cancelButtonText: '<span style="color:#212529">Cancel</span>',
                confirmButtonText: 'Delete'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        }

        // 2. Video Preview
        function playVideo(videoId, title) {
            var iframe = document.getElementById("youtubeFrame");
            document.getElementById("modalTitle").innerText = title;
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        }

        function stopVideo() {
            var iframe = document.getElementById("youtubeFrame");
            iframe.src = "";
        }

        var myModal = document.getElementById('previewModal');
        myModal.addEventListener('hidden.bs.modal', function () {
            stopVideo();
        });

        // 3. Filter Logic
        document.getElementById("trackId").addEventListener("change", function () {
            var trackId = this.value;
            var materialDropdown = document.getElementById("materialId");
            var spinner = document.getElementById("loadingSpinner");

            spinner.classList.remove("d-none");
            materialDropdown.disabled = true;

            if (trackId) {
                fetch(`/Video/GetMaterialsByTrack?trackId=` + trackId)
                    .then(response => response.json())
                    .then(data => {
                        materialDropdown.innerHTML = '<option value="">All Subjects</option>';
                        data.forEach(material => {
                            materialDropdown.innerHTML += `<option value="${material.id}">${material.name}</option>`;
                        });
                    })
                    .finally(() => {
                        spinner.classList.add("d-none");
                        materialDropdown.disabled = false;
                    });
            } else {
                materialDropdown.innerHTML = '<option value="">All Subjects</option>';
                spinner.classList.add("d-none");
                materialDropdown.disabled = false;
            }
        });
    </script>
}